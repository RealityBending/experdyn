# Workflow: render README.qmd → README.md, build pkgdown site, deploy to gh-pages
# Triggers on every push to main and on manual dispatch.

on:
    push:
        branches: [main]
    workflow_dispatch:

name: pkgdown

permissions:
    contents: write # needed to push to gh-pages

jobs:
    pkgdown:
        runs-on: ubuntu-latest
        env:
            GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

        steps:
            # ── 1. Checkout ────────────────────────────────────────────────────────
            - uses: actions/checkout@v4

            # ── 2. Install R ───────────────────────────────────────────────────────
            - uses: r-lib/actions/setup-r@v2
              with:
                  use-public-rspm: true

            # ── 3. Install Quarto ─────────────────────────────────────────────────
            - uses: quarto-dev/quarto-actions/setup@v2

            # ── 4. Install R dependencies (package + pkgdown) ─────────────────────
            - uses: r-lib/actions/setup-r-dependencies@v2
              with:
                  extra-packages: |
                      any::pkgdown
                      any::knitr
                  needs: website

            # ── 5. Install experdyn ────────────────────────────────────────────────
            - name: Install experdyn
              run: Rscript -e 'devtools::install(".", dependencies = TRUE)'

            # ── 6. Render README.qmd → README.md ───────────────────────────────────
            - name: Render README
              run: quarto render README.qmd --to gfm --output README.md

            # ── 7. Build pkgdown site ──────────────────────────────────────────────
            - name: Build pkgdown site
              run: pkgdown::build_site_github_pages(new_process = FALSE, install = FALSE)
              shell: Rscript {0}

            # ── 8. Deploy to gh-pages branch ──────────────────────────────────────
            - name: Deploy to GitHub Pages
              uses: JamesIves/github-pages-deploy-action@v4
              with:
                  clean: true
                  branch: gh-pages
                  folder: docs
